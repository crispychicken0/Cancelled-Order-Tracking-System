<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cancelled Order Management System - CRISPY CHICKEN</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #ff6b35;
      --secondary: #f7931e;
      --success: #28a745;
      --danger: #dc3545;
      --info: #17a2b8;
      --light: #f8f9fa;
      --dark: #343a40;
      --white: #fff;
      --shadow: 0 4px 6px rgba(0,0,0,0.1);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      margin: 0;
      padding: 0;
      direction: ltr;
      color: #333;
      line-height: 1.6;
    }

    .container {
      width: 95%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: var(--white);
      padding: 20px 0;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23ffffff" fill-opacity="0.1" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,122.7C672,117,768,139,864,144C960,149,1056,139,1152,122.7C1248,107,1344,85,1392,74.7L1440,64L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>') no-repeat bottom;
      background-size: cover;
    }

    h1 {
      text-align: center;
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
      position: relative;
      z-index: 1;
    }

    .subtitle {
      text-align: center;
      font-size: 1.2rem;
      opacity: 0.9;
      position: relative;
      z-index: 1;
    }

    .card {
      background: var(--white);
      border-radius: 15px;
      box-shadow: var(--shadow);
      padding: 25px;
      margin-bottom: 25px;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0,0,0,0.15);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--light);
      padding-bottom: 15px;
    }

    .card-title {
      font-size: 1.8rem;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-title i {
      font-size: 1.5rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1rem;
      transition: var(--transition);
      background: var(--white);
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.2);
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn-primary {
      background: var(--primary);
      color: var(--white);
    }

    .btn-primary:hover {
      background: #e55a2b;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 107, 53, 0.3);
    }

    .btn-success {
      background: var(--success);
      color: var(--white);
    }

    .btn-success:hover {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
    }

    .btn-danger {
      background: var(--danger);
      color: var(--white);
    }

    .btn-danger:hover {
      background: #c82333;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
    }

    .btn-info {
      background: var(--info);
      color: var(--white);
    }

    .btn-info:hover {
      background: #138496;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(23, 162, 184, 0.3);
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: var(--white);
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(255, 107, 53, 0.3);
    }

    .stat-card h3 {
      font-size: 2.5rem;
      margin: 10px 0;
      font-weight: 900;
    }

    .stat-card p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .filter-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 20px 0;
    }

    .filter-group input, .filter-group select {
      flex: 1;
      min-width: 200px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: var(--white);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    th, td {
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid #e0e0e0;
    }

    th {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: var(--white);
      font-weight: 700;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .actions {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .actions .btn {
      padding: 8px 12px;
      font-size: 0.9rem;
    }

    .report-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .report-stat {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .report-stat:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }

    .report-stat .value {
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--primary);
      margin: 10px 0;
    }

    .report-stat .label {
      color: #666;
      font-size: 1rem;
    }

    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--success);
      color: var(--white);
      padding: 15px 25px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      display: none;
      align-items: center;
      gap: 10px;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translate(100%, 0);
        opacity: 0;
      }
      to {
        transform: translate(0, 0);
        opacity: 1;
      }
    }

    .notification.show {
      display: flex;
    }

    .notification.error {
      background: var(--danger);
    }

    .notification.info {
      background: var(--info);
    }

    .badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .badge-success {
      background: var(--success);
      color: var(--white);
    }

    .badge-danger {
      background: var(--danger);
      color: var(--white);
    }

    .badge-warning {
      background: #ffc107;
      color: #212529;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: var(--white);
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 600px;
      position: relative;
      box-shadow: var(--shadow);
      max-height: 80vh;
      overflow-y: auto;
    }

    .close-modal {
      position: absolute;
      top: 15px;
      left: 15px;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #999;
    }

    .close-modal:hover {
      color: var(--danger);
    }

    .export-section {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .export-section .btn {
      flex: 1;
      min-width: 200px;
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin: 20px 0;
    }

    .pivot-table {
      width: 100%;
      overflow-x: auto;
      margin: 20px 0;
    }

    .pivot-table table {
      min-width: 100%;
      font-size: 0.9rem;
    }

    .pivot-table th {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .pivot-table .highlight {
      background-color: rgba(255, 107, 53, 0.2);
      font-weight: bold;
    }

    .analysis-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }

    .reason-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .reason-table th, .reason-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }

    .reason-table th {
      background: var(--light);
      font-weight: 600;
    }

    .reason-table tr:nth-child(even) {
      background: #f8f9fa;
    }

    .reason-table tr:hover {
      background: #e9ecef;
    }

    .time-filter {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .time-filter button {
      padding: 8px 15px;
      border: 1px solid var(--primary);
      background: var(--white);
      color: var(--primary);
      border-radius: 5px;
      cursor: pointer;
      transition: var(--transition);
    }

    .time-filter button.active {
      background: var(--primary);
      color: var(--white);
    }

    .time-filter button:hover {
      background: var(--primary);
      color: var(--white);
    }

    .fixed-brand {
      background-color: rgba(255, 107, 53, 0.1);
      border: 2px solid var(--primary);
      color: var(--primary);
      font-weight: bold;
      cursor: not-allowed;
    }

    .location-select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23ff6b35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z'%3E%3C/path%3E%3Ccircle cx='12' cy='10' r='3'%3E%3C/circle%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 10px center;
      padding-left: 40px;
    }

    .reason-select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23ff6b35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 10px center;
      padding-left: 40px;
    }

    .status-select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23ff6b35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M9 11l3 3L22 4'%3E%3C/path%3E%3Cpath d='M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 10px center;
      padding-left: 40px;
    }

    .custom-reason {
      display: none;
      margin-top: 15px;
    }

    .custom-reason.show {
      display: block;
    }

    .reason-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 500;
      margin-right: 5px;
    }

    .reason-badge.customer {
      background-color: #e3f2fd;
      color: #1976d2;
    }

    .reason-badge.driver {
      background-color: #fff3e0;
      color: #f57c00;
    }

    .reason-badge.delivery {
      background-color: #f3e5f5;
      color: #7b1fa2;
    }

    .reason-badge.restaurant {
      background-color: #e8f5e9;
      color: #388e3c;
    }

    .reason-badge.payment {
      background-color: #ffebee;
      color: #c62828;
    }

    .reason-badge.other {
      background-color: #fafafa;
      color: #616161;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-weight: 600;
    }

    .status-badge.accepted {
      color: var(--success);
    }

    .status-badge.not-accepted {
      color: var(--danger);
    }

    .penalty-section {
      background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
      border-radius: 15px;
      padding: 20px;
      margin-top: 20px;
      border-left: 5px solid var(--danger);
    }

    .penalty-section h3 {
      color: var(--danger);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .penalty-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .penalty-item:last-child {
      border-bottom: none;
    }

    .penalty-amount {
      font-weight: bold;
      color: var(--danger);
    }

    .whatsapp-report {
      background: #f0f2f5;
      border-radius: 15px;
      padding: 20px;
      margin-top: 20px;
      border-left: 5px solid #25d366;
    }

    .whatsapp-report h3 {
      color: #25d366;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .whatsapp-report-content {
      background: white;
      border-radius: 10px;
      padding: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      white-space: pre-line;
      overflow-x: auto;
    }

    .whatsapp-actions {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }

    .whatsapp-actions .btn {
      flex: 1;
    }

    .date-picker {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .date-picker input {
      flex: 1;
    }

    .date-picker button {
      padding: 12px 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
    }

    .date-picker button:hover {
      background: #e55a2b;
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      h1 {
        font-size: 1.8rem;
      }
      
      .dashboard {
        grid-template-columns: 1fr;
      }
      
      .filter-group {
        flex-direction: column;
      }
      
      table {
        font-size: 0.9rem;
      }
      
      th, td {
        padding: 10px 5px;
      }
      
      .pivot-table table {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>Cancelled Order Management System</h1>
    <p class="subtitle">CRISPY CHICKEN - Comprehensive order tracking and analytics</p>
  </header>

  <!-- Add Order Form -->
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">
        <i class="fas fa-plus-circle"></i>
        Add New Order
      </h2>
    </div>
    <form id="orderForm">
      <div class="form-grid">
        <div class="form-group">
          <label for="brand">Brand</label>
          <input type="text" id="brand" value="CRISPY CHICKEN" class="fixed-brand" disabled>
        </div>
        <div class="form-group">
          <label for="channel">Channel</label>
          <select id="channel" required>
            <option value="">Select Channel</option>
            <option value="Careem">Careem</option>
            <option value="Zomato">Zomato</option>
            <option value="Talabat">Talabat</option>
            <option value="Deliveroo">Deliveroo</option>
            <option value="Noon">Noon</option>
            <option value="SMILE">SMILE</option>
          </select>
        </div>
        <div class="form-group">
          <label for="branch">Location</label>
          <select id="branch" class="location-select" required>
            <option value="">Select Location</option>
            <option value="Barsha">Barsha</option>
            <option value="Electra">Electra</option>
            <option value="Hamdan">Hamdan</option>
            <option value="Khalydiha">Khalydiha</option>
            <option value="Mouroor">Mouroor</option>
            <option value="Shabiha">Shabiha</option>
            <option value="Satwa">Satwa</option>
          </select>
        </div>
        <div class="form-group">
          <label for="status">Status</label>
          <select id="status" required onchange="toggleReasonStatus()">
            <option value="">Select Status</option>
            <option value="cancelled">Cancelled</option>
            <option value="delivered">Delivered</option>
          </select>
        </div>
        <div class="form-group">
          <label for="price">Order Price (AED)</label>
          <input type="number" id="price" step="0.01" min="0" required>
        </div>
        <div class="form-group">
          <label for="count">Number of Orders</label>
          <input type="number" id="count" min="1" value="1" required>
        </div>
        <div class="form-group">
          <label for="reason">Reason for Cancellation</label>
          <select id="reason" class="reason-select" onchange="toggleCustomReason()">
            <option value="">Select Reason</option>
            <option value="Customer not available">Customer not available</option>
            <option value="Customer cancelled the order">Customer cancelled the order</option>
            <option value="Driver delayed">Driver delayed</option>
            <option value="Delivery issue">Delivery issue</option>
            <option value="Wrong order prepared">Wrong order prepared</option>
            <option value="Restaurant closed early">Restaurant closed early</option>
            <option value="Payment method not available">Payment method not available</option>
            <option value="Other reason (with details)">Other reason (with details)</option>
          </select>
        </div>
        <div class="form-group custom-reason" id="customReasonGroup">
          <label for="customReason">Please specify the reason</label>
          <input type="text" id="customReason" placeholder="e.g., Customer changed their mind">
        </div>
        <div class="form-group" id="reasonStatusGroup" style="display: none;">
          <label for="reasonStatus">Reason Status</label>
          <select id="reasonStatus" class="status-select" required>
            <option value="">Select Status</option>
            <option value="مقبول ✅">مقبول ✅ (Accepted - Valid/Justified)</option>
            <option value="غير مقبول ❌">غير مقبول ❌ (Not Accepted - Unjustified)</option>
          </select>
        </div>
      </div>
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-save"></i>
        Add Order
      </button>
    </form>
  </div>

  <!-- Dashboard -->
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">
        <i class="fas fa-chart-line"></i>
        Dashboard
      </h2>
    </div>
    <div class="dashboard">
      <div class="stat-card">
        <i class="fas fa-shopping-cart fa-2x"></i>
        <h3 id="totalOrders">0</h3>
        <p>Total Orders</p>
      </div>
      <div class="stat-card">
        <i class="fas fa-times-circle fa-2x"></i>
        <h3 id="cancelledOrders">0</h3>
        <p>Cancelled Orders</p>
      </div>
      <div class="stat-card">
        <i class="fas fa-check-circle fa-2x"></i>
        <h3 id="deliveredOrders">0</h3>
        <p>Delivered Orders</p>
      </div>
      <div class="stat-card">
        <i class="fas fa-percentage fa-2x"></i>
        <h3 id="cancellationRate">0%</h3>
        <p>Cancellation Rate</p>
      </div>
      <div class="stat-card">
        <i class="fas fa-exclamation-triangle fa-2x"></i>
        <h3 id="unjustifiedCancellations">0</h3>
        <p>Unjustified Cancellations</p>
      </div>
      <div class="stat-card">
        <i class="fas fa-money-bill-wave fa-2x"></i>
        <h3 id="penaltyAmount">AED 0.00</h3>
        <p>Total Penalty Amount</p>
      </div>
    </div>
    
    <!-- Charts -->
    <div class="analysis-section">
      <div class="chart-container">
        <h3>Cancellation Rate by Channel</h3>
        <canvas id="channelChart"></canvas>
      </div>
      <div class="chart-container">
        <h3>Cancellations by Location</h3>
        <canvas id="locationChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Daily Report for WhatsApp -->
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">
        <i class="fab fa-whatsapp"></i>
        Daily WhatsApp Report
      </h2>
    </div>
    <div class="date-picker">
      <label for="reportDate">Select Date:</label>
      <input type="date" id="reportDate" value="">
      <button onclick="generateWhatsAppReport()">
        <i class="fas fa-file-alt"></i>
        Generate Report
      </button>
    </div>
    <div id="whatsappReportContainer" style="display: none;">
      <div class="whatsapp-report">
        <h3><i class="fab fa-whatsapp"></i> WhatsApp Report Template</h3>
        <div class="whatsapp-report-content" id="whatsappReportContent"></div>
        <div class="whatsapp-actions">
          <button class="btn btn-success" onclick="copyToClipboard()">
            <i class="fas fa-copy"></i>
            Copy to Clipboard
          </button>
          <button class="btn btn-info" onclick="openWhatsApp()">
            <i class="fab fa-whatsapp"></i>
            Send via WhatsApp
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pivot Table -->
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">
        <i class="fas fa-table"></i>
        Pivot Table: Cancellations by Location and Channel
      </h2>
    </div>
    <div class="pivot-table">
      <table id="pivotTable">
        <thead>
          <tr>
            <th>Location</th>
            <th>Careem</th>
            <th>Zomato</th>
            <th>Talabat</th>
            <th>Deliveroo</th>
            <th>Noon</th>
            <th>SMILE</th>
          </tr>
        </thead>
        <tbody id="pivotTableBody">
          <!-- Generated dynamically -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Top Unacceptable Reasons -->
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">
        <i class="fas fa-exclamation-triangle"></i>
        Top Unacceptable Reasons
      </h2>
    </div>
    <div class="time-filter">
      <button class="active" onclick="filterReasons('all')">All Time</button>
      <button onclick="filterReasons('week')">Last Week</button>
      <button onclick="filterReasons('month')">Last Month</button>
    </div>
    <table class="reason-table">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Reason Category</th>
          <th>Reason</th>
          <th>Count</th>
          <th>Percentage</th>
        </tr>
      </thead>
      <tbody id="reasonsTable">
        <!-- Generated dynamically -->
      </tbody>
    </table>
  </div>

  <!-- Penalty Summary -->
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">
        <i class="fas fa-gavel"></i>
        Penalty Summary
      </h2>
    </div>
    <div class="penalty-section">
      <h3><i class="fas fa-exclamation-circle"></i> Unjustified Cancellations Requiring Penalty</h3>
      <div id="penaltySummary">
        <div class="penalty-item">
          <span>No unjustified cancellations found</span>
          <span class="penalty-amount">AED 0.00</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">
        <i class="fas fa-filter"></i>
        Search & Filter
      </h2>
    </div>
    <div class="filter-group">
      <select id="filterBranch">
        <option value="">All Locations</option>
        <option value="Barsha">Barsha</option>
        <option value="Electra">Electra</option>
        <option value="Hamdan">Hamdan</option>
        <option value="Khalydiha">Khalydiha</option>
        <option value="Mouroor">Mouroor</option>
        <option value="Shabiha">Shabiha</option>
        <option value="Satwa">Satwa</option>
      </select>
      <input type="text" id="filterSearch" placeholder="Global search (channel/reason)">
      <select id="filterChannel">
        <option value="">All Channels</option>
        <option value="Careem">Careem</option>
        <option value="Zomato">Zomato</option>
        <option value="Talabat">Talabat</option>
        <option value="Deliveroo">Deliveroo</option>
        <option value="Noon">Noon</option>
        <option value="SMILE">SMILE</option>
      </select>
      <select id="filterStatus">
        <option value="">All Statuses</option>
        <option value="cancelled">Cancelled</option>
        <option value="delivered">Delivered</option>
      </select>
      <select id="filterReasonStatus">
        <option value="">All Reason Statuses</option>
        <option value="مقبول ✅">مقبول ✅ (Accepted)</option>
        <option value="غير مقبول ❌">غير مقبول ❌ (Not Accepted)</option>
      </select>
      <button class="btn btn-info" onclick="resetFilters()">
        <i class="fas fa-redo"></i>
        Reset Filters
      </button>
    </div>
  </div>

  <!-- Orders Table -->
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">
        <i class="fas fa-table"></i>
        Orders
      </h2>
    </div>
    <div style="overflow-x: auto;">
      <table>
        <thead>
          <tr>
            <th>Brand</th>
            <th>Channel</th>
            <th>Location</th>
            <th>Status</th>
            <th>Order Price</th>
            <th>Number of Orders</th>
            <th>Reason for Cancellation</th>
            <th>Reason Status</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="ordersTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Export Options -->
  <div class="export-section">
    <button class="btn btn-success" onclick="exportToCSV()">
      <i class="fas fa-file-csv"></i>
      Export CSV
    </button>
    <button class="btn btn-info" onclick="exportToPDF()">
      <i class="fas fa-file-pdf"></i>
      Export PDF
    </button>
    <button class="btn btn-primary" onclick="exportToJSON()">
      <i class="fas fa-file-code"></i>
      Export JSON
    </button>
  </div>
</div>

<!-- Notifications -->
<div id="notification" class="notification">
  <i class="fas fa-check-circle"></i>
  <span id="notificationText"></span>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeEditModal()">
      <i class="fas fa-times"></i>
    </button>
    <h2 class="card-title">
      <i class="fas fa-edit"></i>
      Edit Order
    </h2>
    <form id="editForm">
      <input type="hidden" id="editIndex">
      <div class="form-grid">
        <div class="form-group">
          <label for="editBrand">Brand</label>
          <input type="text" id="editBrand" value="CRISPY CHICKEN" class="fixed-brand" disabled>
        </div>
        <div class="form-group">
          <label for="editChannel">Channel</label>
          <select id="editChannel" required>
            <option value="Careem">Careem</option>
            <option value="Zomato">Zomato</option>
            <option value="Talabat">Talabat</option>
            <option value="Deliveroo">Deliveroo</option>
            <option value="Noon">Noon</option>
            <option value="SMILE">SMILE</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editBranch">Location</label>
          <select id="editBranch" class="location-select" required>
            <option value="Barsha">Barsha</option>
            <option value="Electra">Electra</option>
            <option value="Hamdan">Hamdan</option>
            <option value="Khalydiha">Khalydiha</option>
            <option value="Mouroor">Mouroor</option>
            <option value="Shabiha">Shabiha</option>
            <option value="Satwa">Satwa</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editStatus">Status</label>
          <select id="editStatus" required onchange="toggleReasonStatusEdit()">
            <option value="cancelled">Cancelled</option>
            <option value="delivered">Delivered</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editPrice">Order Price (AED)</label>
          <input type="number" id="editPrice" step="0.01" min="0" required>
        </div>
        <div class="form-group">
          <label for="editCount">Number of Orders</label>
          <input type="number" id="editCount" min="1" required>
        </div>
        <div class="form-group">
          <label for="editReason">Reason for Cancellation</label>
          <select id="editReason" class="reason-select" onchange="toggleCustomReasonEdit()">
            <option value="Customer not available">Customer not available</option>
            <option value="Customer cancelled the order">Customer cancelled the order</option>
            <option value="Driver delayed">Driver delayed</option>
            <option value="Delivery issue">Delivery issue</option>
            <option value="Wrong order prepared">Wrong order prepared</option>
            <option value="Restaurant closed early">Restaurant closed early</option>
            <option value="Payment method not available">Payment method not available</option>
            <option value="Other reason (with details)">Other reason (with details)</option>
          </select>
        </div>
        <div class="form-group custom-reason" id="customReasonEditGroup">
          <label for="editCustomReason">Please specify the reason</label>
          <input type="text" id="editCustomReason" placeholder="e.g., Customer changed their mind">
        </div>
        <div class="form-group" id="editReasonStatusGroup" style="display: none;">
          <label for="editReasonStatus">Reason Status</label>
          <select id="editReasonStatus" class="status-select" required>
            <option value="مقبول ✅">مقبول ✅ (Accepted - Valid/Justified)</option>
            <option value="غير مقبول ❌">غير مقبول ❌ (Not Accepted - Unjustified)</option>
          </select>
        </div>
      </div>
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-save"></i>
        Save Changes
      </button>
    </form>
  </div>
</div>

<script>
let orders = JSON.parse(localStorage.getItem('orders') || '[]');
let channelChart, locationChart;

// Set today's date as default
document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];

// Toggle reason status visibility based on order status
function toggleReasonStatus() {
  const status = document.getElementById('status').value;
  const reasonStatusGroup = document.getElementById('reasonStatusGroup');
  
  if (status === 'cancelled') {
    reasonStatusGroup.style.display = 'block';
    document.getElementById('reasonStatus').required = true;
  } else {
    reasonStatusGroup.style.display = 'none';
    document.getElementById('reasonStatus').required = false;
    document.getElementById('reasonStatus').value = '';
  }
}

// Toggle reason status visibility in edit modal
function toggleReasonStatusEdit() {
  const status = document.getElementById('editStatus').value;
  const reasonStatusGroup = document.getElementById('editReasonStatusGroup');
  
  if (status === 'cancelled') {
    reasonStatusGroup.style.display = 'block';
    document.getElementById('editReasonStatus').required = true;
  } else {
    reasonStatusGroup.style.display = 'none';
    document.getElementById('editReasonStatus').required = false;
    document.getElementById('editReasonStatus').value = '';
  }
}

// Toggle custom reason input
function toggleCustomReason() {
  const reason = document.getElementById('reason').value;
  const customReasonGroup = document.getElementById('customReasonGroup');
  
  if (reason === 'Other reason (with details)') {
    customReasonGroup.classList.add('show');
    document.getElementById('customReason').required = true;
  } else {
    customReasonGroup.classList.remove('show');
    document.getElementById('customReason').required = false;
    document.getElementById('customReason').value = '';
  }
}

// Toggle custom reason input in edit modal
function toggleCustomReasonEdit() {
  const reason = document.getElementById('editReason').value;
  const customReasonGroup = document.getElementById('customReasonEditGroup');
  
  if (reason === 'Other reason (with details)') {
    customReasonGroup.classList.add('show');
    document.getElementById('editCustomReason').required = true;
  } else {
    customReasonGroup.classList.remove('show');
    document.getElementById('editCustomReason').required = false;
    document.getElementById('editCustomReason').value = '';
  }
}

// Generate WhatsApp report
function generateWhatsAppReport() {
  const reportDate = document.getElementById('reportDate').value;
  if (!reportDate) {
    showNotification('Please select a date', 'error');
    return;
  }
  
  // Filter orders for the selected date
  const selectedDate = new Date(reportDate);
  const filteredOrders = orders.filter(order => {
    const orderDate = new Date(order.date.split(',')[0]);
    return orderDate.toDateString() === selectedDate.toDateString() && order.status === 'cancelled';
  });
  
  // Group by location
  const locations = ['Barsha', 'Electra', 'Hamdan', 'Khalydiha', 'Mouroor', 'Shabiha', 'Satwa'];
  const reportData = {};
  
  locations.forEach(location => {
    const locationOrders = filteredOrders.filter(order => order.branch === location);
    const total = locationOrders.length;
    const accepted = locationOrders.filter(order => order.reasonStatus === 'مقبول ✅').length;
    const notAccepted = locationOrders.filter(order => order.reasonStatus === 'غير مقبول ❌').length;
    
    // Get reasons with status indicators
    const reasons = {};
    locationOrders.forEach(order => {
      const statusIndicator = order.reasonStatus === 'غير مقبول ❌' ? ' ❌' : '';
      if (!reasons[order.reason]) {
        reasons[order.reason] = 0;
      }
      reasons[order.reason]++;
    });
    
    reportData[location] = {
      total,
      accepted,
      notAccepted,
      reasons
    };
  });
  
  // Format the report
  const formattedDate = new Date(reportDate).toLocaleDateString('en-US', { 
    day: '2-digit', 
    month: 'short', 
    year: 'numeric' 
  });
  
  let reportText = `📊 Daily Cancellation Report – ${formattedDate}\n\n`;
  
  for (const [location, data] of Object.entries(reportData)) {
    if (data.total > 0) {
      reportText += `${location}:\n`;
      reportText += `- Total Cancellations: ${data.total}\n`;
      reportText += `- Accepted: ${data.accepted}\n`;
      reportText += `- Not Accepted: ${data.notAccepted}\n`;
      reportText += `- Reasons:\n`;
      
      for (const [reason, count] of Object.entries(data.reasons)) {
        reportText += `   • ${reason} (${count})${data.reasons[reason] > 1 ? 's' : ''}\n`;
      }
      
      reportText += '\n';
    }
  }
  
  reportText += '⚠️ Note:\n';
  reportText += 'Not Accepted = must charge the responsible party (Delivery / Restaurant).\n\n';
  reportText += '✅ Accepted = no one is penalized.\n';
  reportText += '❌ Not Accepted = penalty charged to the responsible party.';
  
  // Display the report
  document.getElementById('whatsappReportContent').textContent = reportText;
  document.getElementById('whatsappReportContainer').style.display = 'block';
  
  // Scroll to the report
  document.getElementById('whatsappReportContainer').scrollIntoView({ behavior: 'smooth' });
  
  showNotification('WhatsApp report generated successfully!', 'success');
}

// Copy to clipboard
function copyToClipboard() {
  const reportText = document.getElementById('whatsappReportContent').textContent;
  navigator.clipboard.writeText(reportText).then(() => {
    showNotification('Report copied to clipboard!', 'success');
  }).catch(err => {
    showNotification('Failed to copy to clipboard', 'error');
  });
}

// Open WhatsApp with pre-filled message
function openWhatsApp() {
  const reportText = document.getElementById('whatsappReportContent').textContent;
  const encodedText = encodeURIComponent(reportText);
  const whatsappUrl = `https://wa.me/?text=${encodedText}`;
  window.open(whatsappUrl, '_blank');
}

// Add new order
document.getElementById('orderForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const brand = document.getElementById('brand').value.trim();
  const channel = document.getElementById('channel').value;
  const branch = document.getElementById('branch').value;
  const status = document.getElementById('status').value;
  const price = parseFloat(document.getElementById('price').value) || 0;
  const count = parseInt(document.getElementById('count').value) || 1;
  const reason = document.getElementById('reason').value;
  const customReason = document.getElementById('customReason').value.trim();
  const reasonStatus = document.getElementById('reasonStatus').value;
  
  if (!channel || !branch || !status) {
    showNotification('Please fill in all required fields', 'error');
    return;
  }
  
  // Validate reason status for cancelled orders
  if (status === 'cancelled' && !reasonStatus) {
    showNotification('Please select a reason status for cancelled orders', 'error');
    return;
  }
  
  const finalReason = reason === 'Other reason (with details)' ? customReason : reason;
  
  const newOrder = {
    id: Date.now(),
    brand,
    channel,
    branch,
    status,
    price,
    count,
    total: price * count,
    reason: finalReason,
    reasonCategory: reason === 'Other reason (with details)' ? 'Other' : reason,
    reasonStatus,
    date: new Date().toLocaleString()
  };
  
  orders.push(newOrder);
  localStorage.setItem('orders', JSON.stringify(orders));
  
  this.reset();
  document.getElementById('customReasonGroup').classList.remove('show');
  document.getElementById('reasonStatusGroup').style.display = 'none';
  renderTable();
  updateDashboard();
  generatePivotTable();
  updateCharts();
  generateReasonsTable('all');
  updatePenaltySummary();
  showNotification('Order added successfully!');
});

// Render table
function renderTable() {
  const tbody = document.getElementById('ordersTable');
  tbody.innerHTML = '';
  
  const filterBranch = document.getElementById('filterBranch').value;
  const filterSearch = document.getElementById('filterSearch').value.toLowerCase();
  const filterChannel = document.getElementById('filterChannel').value;
  const filterStatus = document.getElementById('filterStatus').value;
  const filterReasonStatus = document.getElementById('filterReasonStatus').value;
  
  const filteredOrders = orders.filter(order => {
    const matchChannel = !filterChannel || order.channel === filterChannel;
    const matchBranch = !filterBranch || order.branch === filterBranch;
    const matchStatus = !filterStatus || order.status === filterStatus;
    const matchReasonStatus = !filterReasonStatus || order.reasonStatus === filterReasonStatus;
    const matchSearch = !filterSearch ||
      order.channel.toLowerCase().includes(filterSearch) ||
      order.branch.toLowerCase().includes(filterSearch) ||
      (order.reason && order.reason.toLowerCase().includes(filterSearch)) ||
      (order.reasonCategory && order.reasonCategory.toLowerCase().includes(filterSearch));
      
    return matchChannel && matchBranch && matchStatus && matchReasonStatus && matchSearch;
  });
  
  filteredOrders.forEach((order, index) => {
    const actualIndex = orders.findIndex(o => o.id === order.id);
    
    // Get reason category badge
    let reasonBadge = '';
    if (order.reasonCategory) {
      const category = order.reasonCategory;
      let badgeClass = 'other';
      
      if (category.includes('Customer')) badgeClass = 'customer';
      else if (category.includes('Driver')) badgeClass = 'driver';
      else if (category.includes('Delivery')) badgeClass = 'delivery';
      else if (category.includes('Restaurant')) badgeClass = 'restaurant';
      else if (category.includes('Payment')) badgeClass = 'payment';
      
      reasonBadge = `<span class="reason-badge ${badgeClass}">${category}</span>`;
    }
    
    // Get status badge with styling
    let statusBadge = '';
    if (order.reasonStatus) {
      const statusClass = order.reasonStatus === 'مقبول ✅' ? 'accepted' : 'not-accepted';
      const statusText = order.reasonStatus === 'مقبول ✅' ? 'Accepted' : 'Not Accepted';
      statusBadge = `<span class="status-badge ${statusClass}">${order.reasonStatus} ${statusText}</span>`;
    }
    
    tbody.innerHTML += `
      <tr>
        <td>${order.brand}</td>
        <td>${order.channel}</td>
        <td>${order.branch}</td>
        <td>
          <span class="badge ${order.status === 'cancelled' ? 'badge-danger' : 'badge-success'}">
            ${order.status === 'cancelled' ? 'Cancelled' : 'Delivered'}
          </span>
        </td>
        <td>AED ${order.price.toFixed(2)}</td>
        <td>${order.count}</td>
        <td>
          ${reasonBadge}
          ${order.reason ? `<br>${order.reason}` : ''}
        </td>
        <td>${statusBadge}</td>
        <td>${order.date}</td>
        <td>
          <div class="actions">
            <button class="btn btn-info" onclick="editOrder(${actualIndex})">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-danger" onclick="deleteOrder(${actualIndex})">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </td>
      </tr>
    `;
  });
}

// Update dashboard
function updateDashboard() {
  const total = orders.length;
  const cancelled = orders.filter(o => o.status === 'cancelled').length;
  const delivered = orders.filter(o => o.status === 'delivered').length;
  const rate = total ? ((cancelled/total)*100).toFixed(1) : 0;
  const unjustified = orders.filter(o => o.reasonStatus === 'غير مقبول ❌').length;
  const penaltyAmount = orders
    .filter(o => o.reasonStatus === 'غير مقبول ❌')
    .reduce((sum, o) => sum + o.total, 0);
  
  document.getElementById('totalOrders').textContent = total;
  document.getElementById('cancelledOrders').textContent = cancelled;
  document.getElementById('deliveredOrders').textContent = delivered;
  document.getElementById('cancellationRate').textContent = rate + '%';
  document.getElementById('unjustifiedCancellations').textContent = unjustified;
  document.getElementById('penaltyAmount').textContent = `AED ${penaltyAmount.toFixed(2)}`;
}

// Generate pivot table
function generatePivotTable() {
  const locations = ['Barsha', 'Electra', 'Hamdan', 'Khalydiha', 'Mouroor', 'Shabiha', 'Satwa'];
  const channels = ['Careem', 'Zomato', 'Talabat', 'Deliveroo', 'Noon', 'SMILE'];
  const tbody = document.getElementById('pivotTableBody');
  tbody.innerHTML = '';
  
  locations.forEach(location => {
    const row = document.createElement('tr');
    row.innerHTML = `<td><strong>${location}</strong></td>`;
    
    channels.forEach(channel => {
      const channelOrders = orders.filter(o => o.branch === location && o.channel === channel);
      const totalOrders = channelOrders.reduce((sum, o) => sum + o.count, 0);
      const totalPrice = channelOrders.reduce((sum, o) => sum + o.total, 0);
      const unacceptableCount = channelOrders.filter(o => o.reasonStatus === 'غير مقبول ❌').length;
      
      let cellContent = `${totalOrders}<br>AED ${totalPrice.toFixed(2)}`;
      if (unacceptableCount > 0) {
        cellContent += `<br><span class="badge badge-danger">${unacceptableCount} ❌</span>`;
      }
      
      row.innerHTML += `<td>${cellContent}</td>`;
    });
    
    tbody.appendChild(row);
  });
}

// Update penalty summary
function updatePenaltySummary() {
  const penaltySummary = document.getElementById('penaltySummary');
  const unjustifiedOrders = orders.filter(o => o.reasonStatus === 'غير مقبول ❌');
  
  if (unjustifiedOrders.length === 0) {
    penaltySummary.innerHTML = `
      <div class="penalty-item">
        <span>No unjustified cancellations found</span>
        <span class="penalty-amount">AED 0.00</span>
      </div>
    `;
    return;
  }
  
  let html = '';
  let totalAmount = 0;
  
  unjustifiedOrders.forEach(order => {
    const amount = order.total;
    totalAmount += amount;
    
    html += `
      <div class="penalty-item">
        <span>${order.channel} - ${order.branch}: ${order.reason}</span>
        <span class="penalty-amount">AED ${amount.toFixed(2)}</span>
      </div>
    `;
  });
  
  html += `
    <div class="penalty-item" style="border-top: 2px solid var(--danger); margin-top: 10px; padding-top: 10px; font-weight: bold;">
      <span>Total Penalty Amount</span>
      <span class="penalty-amount">AED ${totalAmount.toFixed(2)}</span>
    </div>
  `;
  
  penaltySummary.innerHTML = html;
}

// Update charts
function updateCharts() {
  // Channel Chart
  const channelData = {};
  const channels = ['Careem', 'Zomato', 'Talabat', 'Deliveroo', 'Noon', 'SMILE'];
  
  channels.forEach(channel => {
    const channelOrders = orders.filter(o => o.channel === channel);
    const cancelled = channelOrders.filter(o => o.status === 'cancelled').length;
    const total = channelOrders.length;
    const rate = total ? (cancelled / total) * 100 : 0;
    channelData[channel] = rate;
  });
  
  if (channelChart) channelChart.destroy();
  
  const channelCtx = document.getElementById('channelChart').getContext('2d');
  channelChart = new Chart(channelCtx, {
    type: 'pie',
    data: {
      labels: Object.keys(channelData),
      datasets: [{
        data: Object.values(channelData),
        backgroundColor: [
          '#ff6b35', '#f7931e', '#28a745', '#17a2b8', '#dc3545', '#6f42c1'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.label}: ${context.raw.toFixed(1)}%`;
            }
          }
        }
      }
    }
  });
  
  // Location Chart
  const locationData = {};
  const locations = ['Barsha', 'Electra', 'Hamdan', 'Khalydiha', 'Mouroor', 'Shabiha', 'Satwa'];
  
  locations.forEach(location => {
    const locationOrders = orders.filter(o => o.branch === location);
    const cancelled = locationOrders.filter(o => o.status === 'cancelled').length;
    locationData[location] = cancelled;
  });
  
  if (locationChart) locationChart.destroy();
  
  const locationCtx = document.getElementById('locationChart').getContext('2d');
  locationChart = new Chart(locationCtx, {
    type: 'bar',
    data: {
      labels: Object.keys(locationData),
      datasets: [{
        label: 'Cancelled Orders',
        data: Object.values(locationData),
        backgroundColor: '#ff6b35',
        borderColor: '#f7931e',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            precision: 0
          }
        }
      }
    }
  });
}

// Generate reasons table
function generateReasonsTable(timeFilter) {
  const tbody = document.getElementById('reasonsTable');
  tbody.innerHTML = '';
  
  let filteredOrders = orders;
  
  if (timeFilter === 'week') {
    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
    filteredOrders = orders.filter(o => new Date(o.date) >= oneWeekAgo);
  } else if (timeFilter === 'month') {
    const oneMonthAgo = new Date();
    oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
    filteredOrders = orders.filter(o => new Date(o.date) >= oneMonthAgo);
  }
  
  const unacceptableOrders = filteredOrders.filter(o => o.reasonStatus === 'غير مقبول ❌');
  const reasonCounts = {};
  const categoryCounts = {};
  
  unacceptableOrders.forEach(order => {
    if (order.reasonCategory) {
      categoryCounts[order.reasonCategory] = (categoryCounts[order.reasonCategory] || 0) + 1;
      
      if (order.reason) {
        const key = order.reasonCategory;
        if (!reasonCounts[key]) {
          reasonCounts[key] = {};
        }
        reasonCounts[key][order.reason] = (reasonCounts[key][order.reason] || 0) + 1;
      }
    }
  });
  
  // Sort categories by count
  const sortedCategories = Object.entries(categoryCounts)
    .sort((a, b) => b[1] - a[1]);
  
  let rank = 1;
  sortedCategories.forEach(([category, count]) => {
    const percentage = unacceptableOrders.length > 0 ? ((count / unacceptableOrders.length) * 100).toFixed(1) : 0;
    
    // Add category row
    tbody.innerHTML += `
      <tr>
        <td>${rank}</td>
        <td colspan="2">
          <span class="reason-badge ${getCategoryClass(category)}">${category}</span>
          <strong>Total: ${count}</strong>
        </td>
        <td>${count}</td>
        <td>${percentage}%</td>
      </tr>
    `;
    
    // Add top reasons for this category
    if (reasonCounts[category]) {
      const sortedReasons = Object.entries(reasonCounts[category])
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3);
      
      sortedReasons.forEach(([reason, count]) => {
        const percentage = unacceptableOrders.length > 0 ? ((count / unacceptableOrders.length) * 100).toFixed(1) : 0;
        tbody.innerHTML += `
          <tr>
            <td></td>
            <td>${category}</td>
            <td>${reason}</td>
            <td>${count}</td>
            <td>${percentage}%</td>
          </tr>
        `;
      });
    }
    
    rank++;
  });
  
  if (sortedCategories.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No unacceptable reasons found</td></tr>';
  }
}

// Get category class for badge styling
function getCategoryClass(category) {
  if (category.includes('Customer')) return 'customer';
  if (category.includes('Driver')) return 'driver';
  if (category.includes('Delivery')) return 'delivery';
  if (category.includes('Restaurant')) return 'restaurant';
  if (category.includes('Payment')) return 'payment';
  return 'other';
}

// Filter reasons by time
function filterReasons(timeFilter) {
  // Update active button
  document.querySelectorAll('.time-filter button').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  generateReasonsTable(timeFilter);
}

// Delete order
function deleteOrder(index) {
  if (confirm('Are you sure you want to delete this order?')) {
    orders.splice(index, 1);
    localStorage.setItem('orders', JSON.stringify(orders));
    renderTable();
    updateDashboard();
    generatePivotTable();
    updateCharts();
    generateReasonsTable('all');
    updatePenaltySummary();
    showNotification('Order deleted successfully!');
  }
}

// Edit order
function editOrder(index) {
  const order = orders[index];
  document.getElementById('editIndex').value = index;
  document.getElementById('editBrand').value = order.brand;
  document.getElementById('editChannel').value = order.channel;
  document.getElementById('editBranch').value = order.branch;
  document.getElementById('editStatus').value = order.status;
  document.getElementById('editPrice').value = order.price;
  document.getElementById('editCount').value = order.count;
  
  // Set reason and custom reason
  document.getElementById('editReason').value = order.reasonCategory || 'Other reason (with details)';
  toggleCustomReasonEdit();
  
  if (order.reasonCategory === 'Other') {
    document.getElementById('editCustomReason').value = order.reason || '';
  }
  
  // Set reason status
  document.getElementById('editReasonStatus').value = order.reasonStatus || '';
  toggleReasonStatusEdit();
  
  document.getElementById('editModal').style.display = 'flex';
}

// Save edit
document.getElementById('editForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const index = parseInt(document.getElementById('editIndex').value);
  const brand = document.getElementById('editBrand').value.trim();
  const channel = document.getElementById('editChannel').value;
  const branch = document.getElementById('editBranch').value;
  const status = document.getElementById('editStatus').value;
  const price = parseFloat(document.getElementById('editPrice').value) || 0;
  const count = parseInt(document.getElementById('editCount').value) || 1;
  const reason = document.getElementById('editReason').value;
  const customReason = document.getElementById('editCustomReason').value.trim();
  const reasonStatus = document.getElementById('editReasonStatus').value;
  
  if (!channel || !branch || !status) {
    showNotification('Please fill in all required fields', 'error');
    return;
  }
  
  // Validate reason status for cancelled orders
  if (status === 'cancelled' && !reasonStatus) {
    showNotification('Please select a reason status for cancelled orders', 'error');
    return;
  }
  
  const finalReason = reason === 'Other reason (with details)' ? customReason : reason;
  const reasonCategory = reason === 'Other reason (with details)' ? 'Other' : reason;
  
  orders[index] = {
    ...orders[index],
    brand,
    channel,
    branch,
    status,
    price,
    count,
    total: price * count,
    reason: finalReason,
    reasonCategory,
    reasonStatus
  };
  
  localStorage.setItem('orders', JSON.stringify(orders));
  renderTable();
  updateDashboard();
  generatePivotTable();
  updateCharts();
  generateReasonsTable('all');
  updatePenaltySummary();
  closeEditModal();
  showNotification('Order updated successfully!');
});

// Close edit modal
function closeEditModal() {
  document.getElementById('editModal').style.display = 'none';
}

// Reset filters
function resetFilters() {
  document.getElementById('filterBranch').value = '';
  document.getElementById('filterSearch').value = '';
  document.getElementById('filterChannel').value = '';
  document.getElementById('filterStatus').value = '';
  document.getElementById('filterReasonStatus').value = '';
  renderTable();
  showNotification('Filters reset', 'info');
}

// Export to CSV
function exportToCSV() {
  let csv = 'Brand,Channel,Location,Status,Order Price,Number of Orders,Reason Category,Reason,Reason Status,Total,Date\n';
  orders.forEach(order => {
    csv += `${order.brand},${order.channel},${order.branch},${order.status},${order.price},${order.count},"${order.reasonCategory || ''}","${order.reason || ''}","${order.reasonStatus || ''}",${order.total},"${order.date}"\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `orders_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
  
  showNotification('CSV exported successfully!');
}

// Export to PDF
function exportToPDF() {
  showNotification('Generating report...', 'info');
  
  const element = document.getElementById('reports');
  const opt = {
    margin: 10,
    filename: `orders_report_${new Date().toISOString().split('T')[0]}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };
  
  html2pdf().set(opt).from(document.querySelector('.container')).save().then(() => {
    showNotification('PDF exported successfully!');
  });
}

// Export to JSON
function exportToJSON() {
  const dataStr = JSON.stringify(orders, null, 2);
  const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
  
  const exportFileDefaultName = `orders_${new Date().toISOString().split('T')[0]}.json`;
  
  const linkElement = document.createElement('a');
  linkElement.setAttribute('href', dataUri);
  linkElement.setAttribute('download', exportFileDefaultName);
  linkElement.click();
  
  showNotification('JSON exported successfully!');
}

// Show notification
function showNotification(message, type = 'success') {
  const notification = document.getElementById('notification');
  const notificationText = document.getElementById('notificationText');
  
  notification.className = 'notification show';
  if (type === 'error') notification.classList.add('error');
  if (type === 'info') notification.classList.add('info');
  
  notificationText.textContent = message;
  
  setTimeout(() => {
    notification.classList.remove('show');
  }, 3000);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  renderTable();
  updateDashboard();
  generatePivotTable();
  updateCharts();
  generateReasonsTable('all');
  updatePenaltySummary();
});
</script>
</body>
</html>
