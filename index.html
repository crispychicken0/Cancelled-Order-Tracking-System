<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>نظام متابعة الطلبات الملغاة</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family: 'Tajawal', sans-serif; }
    .english { font-family: 'Roboto', sans-serif; direction: ltr; }
    .form-input { border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem; }
    .btn-primary { background-color: #dc2626; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; }
    .btn-secondary { background-color: #2563eb; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; }
    .btn-success { background-color: #16a34a; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; }
    .report-section { border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; }
    .report-title { font-size: 1.25rem; font-weight: bold; margin-bottom: 0.75rem; }
    .whatsapp-template { background-color: #f0fdf4; border: 1px dashed #4ade80; border-radius: 0.5rem; padding: 1rem; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="bg-red-600 p-4 text-white text-center">
    <h1 class="text-2xl font-bold">نظام متابعة الطلبات الملغاة</h1>
    <p class="text-sm">Crispy Chicken - نظام إدخال البيانات اليومية</p>
  </header>
  
  <main class="max-w-6xl mx-auto p-4">
    <!-- معلومات التقرير -->
    <div class="bg-white rounded-lg shadow p-4 mb-4">
      <div class="flex justify-between items-center">
        <div>
          <h2 class="text-lg font-semibold">لوحة التحكم</h2>
          <p class="text-sm text-gray-600">التاريخ: <span id="reportDate" class="font-medium"></span></p>
        </div>
        <div class="flex gap-2">
          <button onclick="toggleLanguage()" class="btn-secondary">تبديل اللغة</button>
          <button onclick="exportData()" class="btn-secondary"><i class="fas fa-file-export ml-1"></i> تصدير البيانات</button>
          <button onclick="sendReport()" class="btn-success"><i class="fas fa-paper-plane ml-1"></i> إرسال التقرير</button>
        </div>
      </div>
    </div>
    
    <!-- نموذج إدخال البيانات -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
      <h2 class="text-lg font-semibold mb-4">إدخال بيانات الطلبات الملغاة</h2>
      <form id="orderForm" class="grid grid-cols-1 md:grid-cols-6 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">العلامة التجارية</label>
          <select id="brand" class="form-input w-full" required>
            <option value="Crispy Chicken">Crispy Chicken</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">القناة</label>
          <select id="channel" class="form-input w-full" required>
            <option value="Noon">Noon</option>
            <option value="Talabat">Talabat</option>
            <option value="Careem">Careem</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">الموقع</label>
          <input type="text" id="location" class="form-input w-full" required>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">الحالة</label>
          <select id="status" class="form-input w-full" required>
            <option value="Order Cancelled">Order Cancelled</option>
            <option value="Order Disputed">Order Disputed</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">السعر</label>
          <input type="text" id="price" class="form-input w-full" placeholder="AED 0.00" required>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">عدد الطلبات</label>
          <input type="number" id="orderCount" class="form-input w-full" min="1" value="1" required>
        </div>
        <div class="md:col-span-6">
          <button type="submit" class="btn-primary w-full md:w-auto">
            <i class="fas fa-plus ml-1"></i> إضافة الطلب
          </button>
        </div>
      </form>
    </div>
    
    <!-- إحصائيات التقرير -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-lg shadow p-4 text-center">
        <h3 class="font-semibold">إجمالي الطلبات</h3>
        <p id="totalOrders" class="text-2xl font-bold">0</p>
      </div>
      <div class="bg-white rounded-lg shadow p-4 text-center">
        <h3 class="font-semibold">إجمالي القيمة</h3>
        <p id="totalValue" class="text-2xl font-bold text-blue-600">AED 0.00</p>
      </div>
      <div class="bg-white rounded-lg shadow p-4 text-center">
        <h3 class="font-semibold">طلبات Noon</h3>
        <p id="noonOrders" class="text-2xl font-bold text-yellow-600">0</p>
      </div>
      <div class="bg-white rounded-lg shadow p-4 text-center">
        <h3 class="font-semibold">طلبات Talabat</h3>
        <p id="talabatOrders" class="text-2xl font-bold text-green-600">0</p>
      </div>
    </div>
    
    <!-- الجدول -->
    <div class="overflow-x-auto bg-white rounded-lg shadow mb-6">
      <table id="reportTable" class="w-full border text-center text-sm">
        <thead class="bg-red-100">
          <tr>
            <th class="border px-2 py-1">العلامة التجارية</th>
            <th class="border px-2 py-1">القناة</th>
            <th class="border px-2 py-1">الموقع</th>
            <th class="border px-2 py-1">الحالة</th>
            <th class="border px-2 py-1">السعر</th>
            <th class="border px-2 py-1">عدد الطلبات</th>
            <th class="border px-2 py-1">الإجراءات</th>
          </tr>
        </thead>
        <tbody id="reportBody">
          <!-- سيتم تحميل الصفوف من البيانات المدخلة -->
        </tbody>
      </table>
    </div>
    
    <!-- التقرير الرسمي والرسالة الجاهزة -->
    <div id="detailedReport" class="hidden">
      <!-- التقرير الرسمي -->
      <div class="report-section">
        <h2 class="report-title">تقرير رسمي للطلب الملغي</h2>
        
        <div class="mb-4">
          <h3 class="font-semibold text-lg mb-2">1. معلومات الطلب</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <div class="report-item">
                <span class="report-label">العلامة التجارية:</span> <span id="reportBrand">-</span>
              </div>
              <div class="report-item">
                <span class="report-label">القناة:</span> <span id="reportChannel">-</span>
              </div>
            </div>
            <div>
              <div class="report-item">
                <span class="report-label">الموقع:</span> <span id="reportLocation">-</span>
              </div>
              <div class="report-item">
                <span class="report-label">الحالة:</span> <span id="reportStatus">-</span>
              </div>
            </div>
          </div>
          <div class="report-item">
            <span class="report-label">السعر:</span> <span id="reportPrice">-</span>
          </div>
          <div class="report-item">
            <span class="report-label">عدد الطلبات:</span> <span id="reportOrderCount">-</span>
          </div>
        </div>
        
        <div class="mb-4">
          <h3 class="font-semibold text-lg mb-2">2. الأسئلة المطلوب التأكد منها</h3>
          <table class="w-full border text-sm">
            <thead>
              <tr class="bg-gray-100">
                <th class="border px-2 py-1 text-right">السؤال</th>
                <th class="border px-2 py-1 text-right">غرض السؤال</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="border px-2 py-1">هل تم تسليم الطلب؟</td>
                <td class="border px-2 py-1">التأكد من السبب الحقيقي للإلغاء</td>
              </tr>
              <tr>
                <td class="border px-2 py-1">هل الإلغاء تم بناءً على طلب العميل؟</td>
                <td class="border px-2 py-1">لتحديد ما إذا كان الإلغاء طوعي أو من طرف الطباخ/التطبيق</td>
              </tr>
              <tr>
                <td class="border px-2 py-1">هل لديك إثبات (رسائل أو لقطات شاشة) لتأكيد موافقتك على الإلغاء؟</td>
                <td class="border px-2 py-1">لتجنب أي خصومات أو مستحقات مالية</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="mb-4">
          <h3 class="font-semibold text-lg mb-2">3. التأثير المقترن بالإلغاء</h3>
          <p>الإلغاء قد يؤدي إلى خصومات مالية من الطرفين (مثل دفع قيمة الطعام أو رسوم التحضير)، لذا التأكيد والتوثيق ضروري.</p>
        </div>
        
        <div>
          <h3 class="font-semibold text-lg mb-2">4. الخطوات التالية المقترحة</h3>
          <ol class="list-decimal pl-5 space-y-1">
            <li>توجيه تنبيه فوري للعميل بشأن الإلغاء.</li>
            <li>استلام الرد على الأسئلة أعلاه.</li>
            <li>تحليل ما إذا كان يجب استرجاع رسوم أو اتخاذ إجراء آخر حسب الموقف.</li>
            <li>الحفاظ على المستندات والتراسل كدليل في حال وجود مزيد من الإجراءات.</li>
          </ol>
        </div>
      </div>
      
      <!-- رسالة WhatsApp جاهزة -->
      <div class="whatsapp-template">
        <h3 class="font-semibold text-lg mb-2">رسالة WhatsApp جاهزة للإرسال</h3>
        <div class="mb-3">
          <button onclick="copyWhatsAppMessage()" class="btn-success">
            <i class="fab fa-whatsapp ml-1"></i> نسخ الرسالة
          </button>
        </div>
        <textarea id="whatsappMessage" class="w-full h-40 p-2 border rounded" readonly></textarea>
        <p class="text-sm text-gray-600 mt-2">يمكنك نسخ هذه الرسالة ولصقها في WhatsApp وإرسالها للعميل</p>
      </div>
    </div>
  </main>
  
  <script>
    // ---- LANGUAGE SUPPORT ----
    let currentLanguage = 'ar';
    const translations = {
      ar: {
        orderNumber: "رقم الطلب",
        brand: "العلامة التجارية",
        channel: "القناة",
        location: "الموقع",
        status: "الحالة",
        price: "السعر",
        orderCount: "عدد الطلبات",
        cancelled: "ملغى",
        disputed: "متنازع عليه",
        questions: "الأسئلة المطلوب التأكد منها",
        question: "السؤال",
        purpose: "غرض السؤال",
        q1: "هل تم تسليم الطلب؟",
        p1: "التأكد من السبب الحقيقي للإلغاء",
        q2: "هل الإلغاء تم بناءً على طلب العميل؟",
        p2: "لتحديد ما إذا كان الإلغاء طوعي أو من طرف الطباخ/التطبيق",
        q3: "هل لديك إثبات (رسائل أو لقطات شاشة) لتأكيد موافقتك على الإلغاء؟",
        p3: "لتجنب أي خصومات أو مستحقات مالية",
        impact: "التأثير المقترن بالإلغاء",
        impactText: "الإلغاء قد يؤدي إلى خصومات مالية من الطرفين (مثل دفع قيمة الطعام أو رسوم التحضير)، لذا التأكيد والتوثيق ضروري.",
        nextSteps: "الخطوات التالية المقترحة",
        step1: "توجيه تنبيه فوري للعميل بشأن الإلغاء.",
        step2: "استلام الرد على الأسئلة أعلاه.",
        step3: "تحليل ما إذا كان يجب استرجاع رسوم أو اتخاذ إجراء آخر حسب الموقف.",
        step4: "الحفاظ على المستندات والتراسل كدليل في حال وجود مزيد من الإجراءات.",
        whatsappTitle: "رسالة WhatsApp جاهزة للإرسال",
        copyMessage: "نسخ الرسالة",
        whatsappNote: "يمكنك نسخ هذه الرسالة ولصقها في WhatsApp وإرسالها للعميل",
        whatsappTemplate: `مرحباً،
طلبك من {brand} عبر {channel} ({location}) تم إلغاؤه بتاريخ {date}.
قيمة الطلب: {price}
هل تم تسليمه؟
هل طلبت الإلغاء؟ أم حدث بالإعداد من الطرف الآخر؟
هل لديك إثبات (رسالة أو لقطة شاشة) لموافقتك؟
يرجى الرد على هذه الأسئلة في أقرب وقت لتسوية الأمر وتجنب أي خصومات لاحقة. شكراً لتعاونك.`,
        dataExported: "تم تصدير البيانات بنجاح",
        reportSent: "تم إرسال التقرير بنجاح",
        confirmReport: "هل تريد إرسال التقرير الآن؟",
        confirmDelete: "هل تريد حذف هذا الطلب؟"
      },
      en: {
        orderNumber: "Order Number",
        brand: "Brand",
        channel: "Channel",
        location: "Location",
        status: "Status",
        price: "Price",
        orderCount: "Number of Orders",
        cancelled: "Cancelled",
        disputed: "Disputed",
        questions: "Required Questions to Confirm",
        question: "Question",
        purpose: "Purpose of Question",
        q1: "Was the order delivered?",
        p1: "To confirm the real reason for cancellation",
        q2: "Was the cancellation made at the customer's request?",
        p2: "To determine if the cancellation was voluntary or by the cook/application",
        q3: "Do you have proof (messages or screenshots) to confirm your consent to the cancellation?",
        p3: "To avoid any financial deductions or liabilities",
        impact: "Impact Associated with Cancellation",
        impactText: "Cancellation may lead to financial deductions from both parties (such as paying for the food or preparation fees), so confirmation and documentation are essential.",
        nextSteps: "Proposed Next Steps",
        step1: "Send an immediate alert to the customer regarding the cancellation.",
        step2: "Receive responses to the above questions.",
        step3: "Analyze whether fees should be refunded or other action taken based on the situation.",
        step4: "Maintain documents and correspondence as evidence in case of further actions.",
        whatsappTitle: "Ready-to-Send WhatsApp Message",
        copyMessage: "Copy Message",
        whatsappNote: "You can copy this message and paste it into WhatsApp to send to the customer",
        whatsappTemplate: `Hello,
Your order from {brand} via {channel} ({location}) was cancelled on {date}.
Order value: {price}
Was the order delivered?
Did you request the cancellation? Or did it happen on the other party's end?
Do you have proof (message or screenshot) of your consent?
Please reply to these questions as soon as possible to resolve the matter and avoid any subsequent deductions. Thank you for your cooperation.`,
        dataExported: "Data exported successfully",
        reportSent: "Report sent successfully",
        confirmReport: "Do you want to send the report now?",
        confirmDelete: "Do you want to delete this order?"
      }
    };
    
    // ---- DATA STORAGE ----
    let orders = [];
    
    // ---- INITIALIZE ----
    window.addEventListener('DOMContentLoaded', init);
    
    function init() {
      // عرض التاريخ الحالي
      document.getElementById('reportDate').textContent = new Date().toLocaleDateString('ar-SA');
      
      // تحميل البيانات من التخزين المحلي
      loadData();
      
      // إعداد نموذج الإدخال
      document.getElementById('orderForm').addEventListener('submit', handleFormSubmit);
    }
    
    // ---- LOAD DATA ----
    function loadData() {
      const savedData = localStorage.getItem('cancelledOrders');
      if (savedData) {
        orders = JSON.parse(savedData);
        displayOrders();
        updateStatistics();
      }
    }
    
    // ---- SAVE DATA ----
    function saveData() {
      localStorage.setItem('cancelledOrders', JSON.stringify(orders));
    }
    
    // ---- HANDLE FORM SUBMIT ----
    function handleFormSubmit(e) {
      e.preventDefault();
      
      const order = {
        id: Date.now(),
        brand: document.getElementById('brand').value,
        channel: document.getElementById('channel').value,
        location: document.getElementById('location').value,
        status: document.getElementById('status').value,
        price: document.getElementById('price').value,
        orderCount: parseInt(document.getElementById('orderCount').value),
        date: new Date().toISOString()
      };
      
      orders.push(order);
      saveData();
      displayOrders();
      updateStatistics();
      
      // إعادة تعيين النموذج
      document.getElementById('orderForm').reset();
      document.getElementById('orderCount').value = 1;
      
      // إظهار رسالة نجاح
      showNotification('تمت إضافة الطلب بنجاح', 'success');
    }
    
    // ---- DISPLAY ORDERS ----
    function displayOrders() {
      const tbody = document.getElementById('reportBody');
      tbody.innerHTML = '';
      
      orders.forEach(order => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="border px-2 py-1">${order.brand}</td>
          <td class="border px-2 py-1">${order.channel}</td>
          <td class="border px-2 py-1">${order.location}</td>
          <td class="border px-2 py-1">${order.status}</td>
          <td class="border px-2 py-1">${order.price}</td>
          <td class="border px-2 py-1">${order.orderCount}</td>
          <td class="border px-2 py-1">
            <button onclick="generateDetailedReport(${order.id})" class="btn-secondary text-sm mr-1">
              <i class="fas fa-file-alt"></i>
            </button>
            <button onclick="deleteOrder(${order.id})" class="bg-red-500 text-white px-2 py-1 rounded text-sm">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    // ---- UPDATE STATISTICS ----
    function updateStatistics() {
      const totalOrders = orders.reduce((sum, order) => sum + order.orderCount, 0);
      const noonOrders = orders.filter(order => order.channel === 'Noon').reduce((sum, order) => sum + order.orderCount, 0);
      const talabatOrders = orders.filter(order => order.channel === 'Talabat').reduce((sum, order) => sum + order.orderCount, 0);
      
      // حساب إجمالي القيمة (تحويل السعر إلى رقم)
      const totalValue = orders.reduce((sum, order) => {
        const price = parseFloat(order.price.replace(/[^0-9.-]+/g, ''));
        return sum + (price * order.orderCount);
      }, 0);
      
      document.getElementById('totalOrders').textContent = totalOrders;
      document.getElementById('totalValue').textContent = `AED ${totalValue.toFixed(2)}`;
      document.getElementById('noonOrders').textContent = noonOrders;
      document.getElementById('talabatOrders').textContent = talabatOrders;
    }
    
    // ---- DELETE ORDER ----
    function deleteOrder(id) {
      if (confirm(translations[currentLanguage].confirmDelete)) {
        orders = orders.filter(order => order.id !== id);
        saveData();
        displayOrders();
        updateStatistics();
        showNotification('تم حذف الطلب بنجاح', 'success');
      }
    }
    
    // ---- EXPORT DATA ----
    function exportData() {
      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += "BRAND,CHANNEL,LOCATION,STATUS,ORDER PRICE,NUMBER OF ORDERS\n";
      
      orders.forEach(order => {
        csvContent += `${order.brand},${order.channel},${order.location},${order.status},${order.price},${order.orderCount}\n`;
      });
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `cancelled_orders_${new Date().toISOString().slice(0, 10)}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showNotification(translations[currentLanguage].dataExported, 'success');
    }
    
    // ---- SEND REPORT ----
    function sendReport() {
      if (confirm(translations[currentLanguage].confirmReport)) {
        // هنا يمكنك إضافة كود إرسال التقرير عبر البريد الإلكتروني
        showNotification(translations[currentLanguage].reportSent, 'success');
      }
    }
    
    // ---- LANGUAGE TOGGLE ----
    function toggleLanguage() {
      currentLanguage = currentLanguage === 'ar' ? 'en' : 'ar';
      document.body.dir = currentLanguage === 'ar' ? 'rtl' : 'ltr';
      document.body.className = currentLanguage === 'ar' ? 'bg-gray-50 text-gray-900' : 'bg-gray-50 text-gray-900 english';
      
      // تحديث التاريخ حسب اللغة
      if (currentLanguage === 'ar') {
        document.getElementById('reportDate').textContent = new Date().toLocaleDateString('ar-SA');
      } else {
        document.getElementById('reportDate').textContent = new Date().toLocaleDateString('en-US');
      }
      
      // إذا كان هناك تقرير مفصل معروض، قم بتحديثه
      const detailedReport = document.getElementById('detailedReport');
      if (!detailedReport.classList.contains('hidden')) {
        const orderId = detailedReport.dataset.orderId;
        generateDetailedReport(orderId);
      }
    }
    
    // ---- DETAILED REPORT ----
    function generateDetailedReport(orderId) {
      const order = orders.find(o => o.id == orderId);
      if (!order) return;
      
      // تحديث التقرير الرسمي
      document.getElementById('reportBrand').textContent = order.brand;
      document.getElementById('reportChannel').textContent = order.channel;
      document.getElementById('reportLocation').textContent = order.location;
      document.getElementById('reportStatus').textContent = order.status;
      document.getElementById('reportPrice').textContent = order.price;
      document.getElementById('reportOrderCount').textContent = order.orderCount;
      
      // تحديث رسالة WhatsApp
      const whatsappTemplate = translations[currentLanguage].whatsappTemplate;
      const whatsappMessage = whatsappTemplate
        .replace('{brand}', order.brand)
        .replace('{channel}', order.channel)
        .replace('{location}', order.location)
        .replace('{date}', new Date(order.date).toLocaleDateString(currentLanguage === 'ar' ? 'ar-SA' : 'en-US'))
        .replace('{price}', order.price);
      
      document.getElementById('whatsappMessage').value = whatsappMessage;
      
      // حفظ معرف الطلب الحالي
      const detailedReport = document.getElementById('detailedReport');
      detailedReport.dataset.orderId = orderId;
      detailedReport.classList.remove('hidden');
      
      // التمرير إلى التقرير المفصل
      detailedReport.scrollIntoView({ behavior: 'smooth' });
    }
    
    // ---- COPY WHATSAPP MESSAGE ----
    function copyWhatsAppMessage() {
      const whatsappMessage = document.getElementById('whatsappMessage');
      whatsappMessage.select();
      document.execCommand('copy');
      
      // تغيير نص الزر مؤقتاً
      const button = event.target;
      const originalText = button.innerHTML;
      button.innerHTML = '<i class="fas fa-check ml-1"></i> ' + (currentLanguage === 'ar' ? 'تم النسخ!' : 'Copied!');
      
      setTimeout(() => {
        button.innerHTML = originalText;
      }, 2000);
    }
    
    // ---- SHOW NOTIFICATION ----
    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }
  </script>
</body>
</html>
